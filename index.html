<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>写真キャプション合成ツール</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
/* ============================
   全体スタイル（ゴシック統一）
============================ */
body {
  margin: 0;
  padding: 16px;
  background: #111;
  color: #eee;
  font-family: "Noto Sans JP", "Yu Gothic", "游ゴシック体", "Hiragino Sans", "Meiryo", sans-serif;
}

h1 {
  margin: 0 0 12px;
  font-size: 20px;
}

.container {
  display: grid;
  grid-template-columns: 300px 1fr;
  gap: 16px;
}

/* ============================
   左ペイン（PC）
============================ */
.panel {
  background: #181818;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 12px;
}

.panel h2 {
  margin: 0 0 8px;
  font-size: 14px;
  border-bottom: 1px solid #333;
  padding-bottom: 4px;
}

#dropZone {
  border: 2px dashed #666;
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  color: #ccc;
  margin-bottom: 8px;
  cursor: pointer;
}

#dropZone.dragover {
  border-color: #4fc3f7;
  background: rgba(79,195,247,0.05);
}

input, select, button, textarea {
  font-family: inherit;
  font-size: 12px;
}

button {
  padding: 6px 10px;
  border: 1px solid #555;
  background: #333;
  color: #eee;
  border-radius: 4px;
  cursor: pointer;
}

button:hover {
  background: #444;
}

button:disabled {
  opacity: 0.4;
  cursor: default;
}

.btn-row {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin: 6px 0;
}

.setting-block {
  margin: 10px 0;
  font-size: 12px;
}

.setting-block label {
  display: block;
  margin-bottom: 4px;
}

.setting-block .input-row {
  display: flex;
  gap: 6px;
  align-items: center;
}

.setting-block input[type="range"] {
  flex: 1;
}

.setting-block input[type="number"] {
  width: 80px;
}

.info {
  font-size: 11px;
  color: #aaa;
  max-height: 160px;
  overflow-y: auto;
}

.thumb-list {
  max-height: 200px;
  overflow-y: auto;
  font-size: 11px;
}

.thumb-item {
  padding: 4px;
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
}

.thumb-item.active {
  background: #2e7d32;
}

.thumb-item:hover {
  background: #333;
}

.status {
  font-size: 11px;
  color: #aaa;
  margin-top: 4px;
}

/* ============================
   プレビュー
============================ */
.preview-wrapper {
  border: 1px solid #333;
  border-radius: 8px;
  height: calc(100vh - 80px);
  display: flex;
  align-items: center;
  justify-content: center;
  background: #000;
  position: relative;
}

canvas {
  max-width: 100%;
  max-height: 100%;
  background: #000;
}

/* ★ 画像がないとき中央に出すボタン */
.initial-load-button {
  position: absolute;
  z-index: 50;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  padding: 16px 28px;
  font-size: 18px;
  background: #333;
  color: #fff;
  border: 1px solid #666;
  border-radius: 8px;
  display: none;
}

/* ============================
   スマホUI
============================ */
@media (max-width: 768px) {

  body {
    padding: 8px;
  }

  h1 {
    font-size: 16px;
    margin-bottom: 8px;
  }

  .container {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .panel {
    display: none !important;
  }

  .preview-wrapper {
    height: auto;
    min-height: 50vh;
  }

  /* 下部ツールバー */
  .mobile-toolbar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #222;
    padding: 10px 0;
    display: flex;
    justify-content: space-around;
    border-top: 1px solid #444;
    z-index: 1000;
  }

  .mobile-toolbar button {
    background: none;
    border: none;
    color: #eee;
    font-size: 13px;
    font-weight: 600;
    padding: 6px 4px;
  }

  /* スライドパネル */
  .mobile-panel {
    display: none;
    position: fixed;
    bottom: 60px;
    left: 0;
    right: 0;
    background: #181818;
    padding: 16px;
    border-top: 1px solid #333;
    z-index: 1000;
  }

  .mobile-panel.open {
    display: block;
  }

  .mobile-panel h3 {
    margin: 0 0 12px;
    font-size: 16px;
    color: #fff;
  }

  .mobile-panel input[type="range"] {
    width: 100%;
    margin: 8px 0 16px;
  }

  .value-display {
    font-size: 14px;
    color: #aaa;
    margin-top: -8px;
    margin-bottom: 12px;
  }
}
</style>
</head>

<body>

<h1>写真キャプション合成ツール</h1>

<div class="container">

  <!-- 左ペイン（PC） -->
  <div class="panel">
    <!-- ここに PC UI が入る（Part 2 で続く） -->

  <script>
/* ============================================================
   グローバル状態
============================================================ */
const state = {
  items: [],            // 読み込んだ画像データ
  currentIndex: -1,     // 現在の画像インデックス
  caption: "",          // キャプション文字列
  fontFamily: "Noto Sans JP",
  fontSize: 48,
  fontWeight: "bold",
  fontColor: "#ffffff",
  strokeColor: "#000000",
  strokeWidth: 4,
  captionGap: 40,
  marginLeft: 40,
  marginRight: 40,
  marginBottom: 40,
  align: "center",
};

/* DOM 取得 */
const fileInput = document.getElementById("fileInput");
const previewCanvas = document.getElementById("previewCanvas");
const ctx = previewCanvas.getContext("2d");

/* PC UI 要素 */
const captionInput = document.getElementById("captionInput");
const fontFamilySelect = document.getElementById("fontFamily");
const fontSizeSlider = document.getElementById("fontSizeSlider");
const fontSizeNumber = document.getElementById("fontSizeNumber");
const fontColorInput = document.getElementById("fontColor");
const strokeColorInput = document.getElementById("strokeColor");
const strokeWidthSlider = document.getElementById("strokeWidthSlider");
const strokeWidthNumber = document.getElementById("strokeWidthNumber");
const captionGapSlider = document.getElementById("captionGapSlider");
const captionGapNumber = document.getElementById("captionGapNumber");
const marginLeftSlider = document.getElementById("marginLeftSlider");
const marginLeftNumber = document.getElementById("marginLeftNumber");
const marginRightSlider = document.getElementById("marginRightSlider");
const marginRightNumber = document.getElementById("marginRightNumber");
const marginBottomSlider = document.getElementById("marginBottomSlider");
const marginBottomNumber = document.getElementById("marginBottomNumber");
const alignSelect = document.getElementById("alignSelect");

const thumbList = document.getElementById("thumbList");
const statusEl = document.getElementById("status");

/* スマホ UI */
const mobilePanels = {
  font: document.getElementById("mobilePanelFont"),
  size: document.getElementById("mobilePanelSize"),
  pos: document.getElementById("mobilePanelPos"),
  margin: document.getElementById("mobilePanelMargin"),
};

const mobileFontSizeSlider = document.getElementById("mobileFontSizeSlider");
const mobileFontSizeValue = document.getElementById("mobileFontSizeValue");
const mobileCaptionGapSlider = document.getElementById("mobileCaptionGapSlider");
const mobileCaptionGapValue = document.getElementById("mobileCaptionGapValue");
const mobileMarginBottomSlider = document.getElementById("mobileMarginBottomSlider");
const mobileMarginBottomValue = document.getElementById("mobileMarginBottomValue");

/* ============================================================
   ステータス表示
============================================================ */
function setStatus(msg) {
  statusEl.textContent = msg;
}

/* ============================================================
   ファイル読み込み
============================================================ */
fileInput.addEventListener("change", async (e) => {
  const files = [...e.target.files];
  if (files.length === 0) return;

  setStatus("読み込み中…");

  for (const file of files) {
    const url = URL.createObjectURL(file);
    const img = await loadImage(url);

    state.items.push({
      file,
      url,
      img,
      width: img.width,
      height: img.height,
    });
  }

  if (state.currentIndex === -1) {
    state.currentIndex = 0;
  }

  updateThumbList();
  updateView();
  setStatus("読み込み完了");
});

/* 画像読み込み Promise */
function loadImage(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.src = url;
  });
}

/* ============================================================
   サムネイル更新
============================================================ */
function updateThumbList() {
  thumbList.innerHTML = "";

  state.items.forEach((item, i) => {
    const div = document.createElement("div");
    div.className = "thumb-item" + (i === state.currentIndex ? " active" : "");
    div.textContent = item.file.name;

    div.onclick = () => {
      state.currentIndex = i;
      updateThumbList();
      updateView();
    };

    thumbList.appendChild(div);
  });
}

/* ============================================================
   プレビュー描画
============================================================ */
function updateView() {
  const item = state.items[state.currentIndex];
  const initialBtn = document.getElementById("initialLoadButton");

  if (!item) {
    ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
    initialBtn.style.display = "block";
    return;
  }

  initialBtn.style.display = "none";

  previewCanvas.width = item.width;
  previewCanvas.height = item.height;

  ctx.drawImage(item.img, 0, 0);

  drawCaption();
}

/* ============================================================
   キャプション描画
============================================================ */
function drawCaption() {
  const text = state.caption;
  if (!text) return;

  ctx.font = `${state.fontWeight} ${state.fontSize}px "${state.fontFamily}"`;
  ctx.textBaseline = "bottom";
  ctx.lineJoin = "round";

  const lines = text.split("\n");
  const lineHeight = state.fontSize + state.captionGap;

  let x;
  if (state.align === "left") x = state.marginLeft;
  else if (state.align === "right") x = previewCanvas.width - state.marginRight;
  else x = previewCanvas.width / 2;

  let y = previewCanvas.height - state.marginBottom;

  ctx.lineWidth = state.strokeWidth;
  ctx.strokeStyle = state.strokeColor;
  ctx.fillStyle = state.fontColor;

  for (let i = lines.length - 1; i >= 0; i--) {
    const line = lines[i];

    if (state.align === "center") {
      ctx.textAlign = "center";
    } else if (state.align === "left") {
      ctx.textAlign = "left";
    } else {
      ctx.textAlign = "right";
    }

    ctx.strokeText(line, x, y);
    ctx.fillText(line, x, y);

    y -= lineHeight;
  }
}
    /* ============================================================
   PC UI イベント
============================================================ */
captionInput.addEventListener("input", () => {
  state.caption = captionInput.value;
  updateView();
});

fontFamilySelect.addEventListener("change", () => {
  state.fontFamily = fontFamilySelect.value;
  updateView();
});

fontSizeSlider.addEventListener("input", () => {
  state.fontSize = Number(fontSizeSlider.value);
  fontSizeNumber.value = state.fontSize;
  updateView();
});
fontSizeNumber.addEventListener("input", () => {
  state.fontSize = Number(fontSizeNumber.value);
  fontSizeSlider.value = state.fontSize;
  updateView();
});

fontColorInput.addEventListener("input", () => {
  state.fontColor = fontColorInput.value;
  updateView();
});

strokeColorInput.addEventListener("input", () => {
  state.strokeColor = strokeColorInput.value;
  updateView();
});

strokeWidthSlider.addEventListener("input", () => {
  state.strokeWidth = Number(strokeWidthSlider.value);
  strokeWidthNumber.value = state.strokeWidth;
  updateView();
});
strokeWidthNumber.addEventListener("input", () => {
  state.strokeWidth = Number(strokeWidthNumber.value);
  strokeWidthSlider.value = state.strokeWidth;
  updateView();
});

captionGapSlider.addEventListener("input", () => {
  state.captionGap = Number(captionGapSlider.value);
  captionGapNumber.value = state.captionGap;
  updateView();
});
captionGapNumber.addEventListener("input", () => {
  state.captionGap = Number(captionGapNumber.value);
  captionGapSlider.value = state.captionGap;
  updateView();
});

marginLeftSlider.addEventListener("input", () => {
  state.marginLeft = Number(marginLeftSlider.value);
  marginLeftNumber.value = state.marginLeft;
  updateView();
});
marginLeftNumber.addEventListener("input", () => {
  state.marginLeft = Number(marginLeftNumber.value);
  marginLeftSlider.value = state.marginLeft;
  updateView();
});

marginRightSlider.addEventListener("input", () => {
  state.marginRight = Number(marginRightSlider.value);
  marginRightNumber.value = state.marginRight;
  updateView();
});
marginRightNumber.addEventListener("input", () => {
  state.marginRight = Number(marginRightNumber.value);
  marginRightSlider.value = state.marginRight;
  updateView();
});

marginBottomSlider.addEventListener("input", () => {
  state.marginBottom = Number(marginBottomSlider.value);
  marginBottomNumber.value = state.marginBottom;
  updateView();
});
marginBottomNumber.addEventListener("input", () => {
  state.marginBottom = Number(marginBottomNumber.value);
  marginBottomSlider.value = state.marginBottom;
  updateView();
});

alignSelect.addEventListener("change", () => {
  state.align = alignSelect.value;
  updateView();
});

/* ============================================================
   スマホ UI イベント
============================================================ */
function openMobilePanel(name) {
  Object.values(mobilePanels).forEach((p) => p.classList.remove("open"));
  mobilePanels[name].classList.add("open");
}

document.getElementById("btnFont").onclick = () => openMobilePanel("font");
document.getElementById("btnSize").onclick = () => openMobilePanel("size");
document.getElementById("btnPos").onclick = () => openMobilePanel("pos");
document.getElementById("btnMargin").onclick = () => openMobilePanel("margin");

mobileFontSizeSlider.addEventListener("input", () => {
  state.fontSize = Number(mobileFontSizeSlider.value);
  mobileFontSizeValue.textContent = `${state.fontSize}px`;
  updateView();
});

mobileCaptionGapSlider.addEventListener("input", () => {
  state.captionGap = Number(mobileCaptionGapSlider.value);
  mobileCaptionGapValue.textContent = `${state.captionGap}px`;
  updateView();
});

mobileMarginBottomSlider.addEventListener("input", () => {
  state.marginBottom = Number(mobileMarginBottomSlider.value);
  mobileMarginBottomValue.textContent = `${state.marginBottom}px`;
  updateView();
});

/* ============================================================
   画像保存
============================================================ */
document.getElementById("saveButton").onclick = () => {
  const item = state.items[state.currentIndex];
  if (!item) return;

  const a = document.createElement("a");
  a.href = previewCanvas.toDataURL("image/jpeg", 0.92);
  a.download = item.file.name.replace(/\.[^.]+$/, "") + "_caption.jpg";
  a.click();
};

/* ============================================================
   ドラッグ＆ドロップ
============================================================ */
const dropZone = document.getElementById("dropZone");

dropZone.addEventListener("dragover", (e) => {
  e.preventDefault();
  dropZone.classList.add("dragover");
});

dropZone.addEventListener("dragleave", () => {
  dropZone.classList.remove("dragover");
});

dropZone.addEventListener("drop", async (e) => {
  e.preventDefault();
  dropZone.classList.remove("dragover");

  const files = [...e.dataTransfer.files];
  if (files.length === 0) return;

  setStatus("読み込み中…");

  for (const file of files) {
    const url = URL.createObjectURL(file);
    const img = await loadImage(url);

    state.items.push({
      file,
      url,
      img,
      width: img.width,
      height: img.height,
    });
  }

  if (state.currentIndex === -1) {
    state.currentIndex = 0;
  }

  updateThumbList();
  updateView();
  setStatus("読み込み完了");
});

/* ============================================================
   初期状態同期（スマホ）
============================================================ */
function syncMobileFromState() {
  mobileFontSizeSlider.value = state.fontSize;
  mobileFontSizeValue.textContent = `${state.fontSize}px`;

  mobileCaptionGapSlider.value = state.captionGap;
  mobileCaptionGapValue.textContent = `${state.captionGap}px`;

  mobileMarginBottomSlider.value = state.marginBottom;
  mobileMarginBottomValue.textContent = `${state.marginBottom}px`;
}

/* ============================================================
   初期化
============================================================ */
syncMobileFromState();
setStatus("画像を読み込んでください");

/* 画像がないとき中央ボタンで読み込み */
document.getElementById("initialLoadButton").onclick = () => {
  fileInput.click();
};
</script>

</body>
</html>
