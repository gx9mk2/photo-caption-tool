<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>写真キャプション合成ツール（スマホ専用）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Zen+Antique&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ---------------------------------------
   全体の基本デザイン（iOS風）
--------------------------------------- */
body {
  margin: 0;
  padding: 0;
  background: #f2f2f7;
  font-family: "Noto Sans JP", sans-serif;
  color: #333;
  -webkit-user-select: none;
  user-select: none;
}

/* ---------------------------------------
   写真選択ボタン
--------------------------------------- */
#selectPhotoBtn {
  width: 90%;
  margin: 16px auto;
  display: block;
  padding: 14px;
  background: #fff;
  border-radius: 12px;
  border: 1px solid #ddd;
  text-align: center;
  font-size: 16px;
  color: #ff6600;
  font-weight: 600;
}

/* ---------------------------------------
   プレビュー領域
--------------------------------------- */
#previewArea {
  width: 100%;
  height: 60vh;
  background: #e5e5ea;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
}

#previewCanvas {
  touch-action: none; /* ピンチズーム用 */
  transform-origin: center center;
}

/* ---------------------------------------
   書き出しボタン
--------------------------------------- */
#exportBtn {
  width: 90%;
  margin: 12px auto;
  display: block;
  padding: 14px;
  background: #ff6600;
  color: #fff;
  border-radius: 12px;
  border: none;
  font-size: 17px;
  font-weight: 600;
}

/* ---------------------------------------
   下部ツールバー（固定）
--------------------------------------- */
#toolbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 58px;
  background: #fff;
  border-top: 1px solid #ddd;
  display: flex;
  justify-content: space-around;
  align-items: center;
}

.toolbar-item {
  text-align: center;
  font-size: 11px;
  color: #888;
}

.toolbar-item.active {
  color: #ff6600;
  font-weight: 600;
}

/* ---------------------------------------
   スライドアップパネル
--------------------------------------- */
#panel {
  position: fixed;
  left: 0;
  right: 0;
  bottom: -300px; /* 初期は隠す */
  height: 300px;
  background: #fff;
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  padding: 16px;
  transition: bottom 0.25s ease;
}

#panel.open {
  bottom: 58px; /* ツールバーの上に表示 */
}

.panel-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
}

.panel-content {
  font-size: 14px;
}
</style>
</head>

<body>

<button id="selectPhotoBtn">＋ 写真を選ぶ</button>

<div id="previewArea">
  <canvas id="previewCanvas"></canvas>
</div>

<button id="exportBtn">書き出す</button>

<!-- 下部ツールバー -->
<div id="toolbar">
  <div class="toolbar-item" data-panel="font">FONT</div>
  <div class="toolbar-item" data-panel="size">SIZE</div>
  <div class="toolbar-item" data-panel="pos">POS</div>
  <div class="toolbar-item" data-panel="margin">MARGIN</div>
  <div class="toolbar-item" data-panel="color">COLOR</div>
  <div class="toolbar-item" data-panel="text">TEXT</div>
</div>

<!-- スライドアップパネル -->
<div id="panel">
  <div class="panel-title" id="panelTitle">設定</div>
  <div class="panel-content" id="panelContent">
    <!-- JSで内容を差し替える -->
  </div>
</div>

<script>
/* ---------------------------------------
   ピンチズーム & ドラッグ（画像だけ拡大）
--------------------------------------- */
const canvas = document.getElementById("previewCanvas");
const ctx = canvas.getContext("2d");

let img = null;              // 読み込んだ画像
let scale = 1;               // 現在の拡大率
let minScale = 0.5;
let maxScale = 4.0;

let offsetX = 0;             // ドラッグ移動量
let offsetY = 0;

let lastTouchDistance = 0;   // ピンチ距離
let lastTouchX = 0;
let lastTouchY = 0;

let isDragging = false;

/* ---------------------------------------
   画像読み込み
--------------------------------------- */
function loadImageToCanvas(file) {
  const reader = new FileReader();
  reader.onload = () => {
    img = new Image();
    img.onload = () => {
      resetTransform();
      draw();
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
}

/* ---------------------------------------
   描画処理
--------------------------------------- */
function draw() {
  if (!img) return;

  canvas.width = previewArea.clientWidth;
  canvas.height = previewArea.clientHeight;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  ctx.translate(canvas.width / 2 + offsetX, canvas.height / 2 + offsetY);
  ctx.scale(scale, scale);
  ctx.drawImage(img, -img.width / 2, -img.height / 2);
  ctx.restore();
}

/* ---------------------------------------
   ピンチ距離計算
--------------------------------------- */
function getDistance(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

/* ---------------------------------------
   リセット（ダブルタップ）
--------------------------------------- */
function resetTransform() {
  scale = 1;
  offsetX = 0;
  offsetY = 0;
}

/* ---------------------------------------
   タッチイベント
--------------------------------------- */
canvas.addEventListener("touchstart", (e) => {
  if (e.touches.length === 1) {
    // ドラッグ開始
    isDragging = true;
    lastTouchX = e.touches[0].clientX;
    lastTouchY = e.touches[0].clientY;
  } else if (e.touches.length === 2) {
    // ピンチ開始
    lastTouchDistance = getDistance(e.touches);
  }
});

canvas.addEventListener("touchmove", (e) => {
  e.preventDefault();

  if (!img) return;

  if (e.touches.length === 1 && isDragging) {
    // ドラッグ
    const x = e.touches[0].clientX;
    const y = e.touches[0].clientY;

    offsetX += x - lastTouchX;
    offsetY += y - lastTouchY;

    lastTouchX = x;
    lastTouchY = y;

    draw();
  }

  if (e.touches.length === 2) {
    // ピンチズーム
    const newDist = getDistance(e.touches);
    const delta = newDist - lastTouchDistance;

    scale += delta * 0.005;
    scale = Math.max(minScale, Math.min(maxScale, scale));

    lastTouchDistance = newDist;

    draw();
  }
});

canvas.addEventListener("touchend", (e) => {
  isDragging = false;
});

/* ---------------------------------------
   ダブルタップでリセット
--------------------------------------- */
let lastTap = 0;
canvas.addEventListener("touchend", () => {
  const now = Date.now();
  if (now - lastTap < 300) {
    resetTransform();
    draw();
  }
  lastTap = now;
});

  /* ---------------------------------------
   EXIF 読み込み（必要最小限）
--------------------------------------- */
async function readExif(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const view = new DataView(e.target.result);

        // JPEG 以外は無視
        if (view.getUint16(0) !== 0xFFD8) return resolve({});

        let offset = 2;
        while (offset < view.byteLength) {
          const marker = view.getUint16(offset);
          offset += 2;

          if (marker === 0xFFE1) {
            const length = view.getUint16(offset);
            offset += 2;

            // "Exif" チェック
            if (view.getUint32(offset) === 0x45786966) {
              return resolve(parseExifBlock(view, offset + 6));
            }
          } else {
            offset += view.getUint16(offset);
          }
        }
      } catch (err) {
        console.log("EXIF error:", err);
      }
      resolve({});
    };
    reader.readAsArrayBuffer(file);
  });
}

function parseExifBlock(view, start) {
  const little = view.getUint16(start) === 0x4949;
  const offset = view.getUint32(start + 4, little);

  const exif = {};

  function getValue(entryOffset, type, count, valueOffset) {
    if (type === 2) {
      let s = "";
      for (let i = 0; i < count - 1; i++) {
        s += String.fromCharCode(view.getUint8(start + valueOffset + i));
      }
      return s;
    }
    if (type === 5) {
      const num = view.getUint32(start + valueOffset, little);
      const den = view.getUint32(start + valueOffset + 4, little);
      return num / den;
    }
    return null;
  }

  const numEntries = view.getUint16(start + offset, little);
  for (let i = 0; i < numEntries; i++) {
    const entry = start + offset + 2 + i * 12;
    const tag = view.getUint16(entry, little);
    const type = view.getUint16(entry + 2, little);
    const count = view.getUint32(entry + 4, little);
    const valueOffset = view.getUint32(entry + 8, little);

    if (tag === 0x0110) exif.Model = getValue(entry, type, count, valueOffset);
    if (tag === 0x9003) exif.DateTimeOriginal = getValue(entry, type, count, valueOffset);
    if (tag === 0x829A) exif.ExposureTime = getValue(entry, type, count, valueOffset);
    if (tag === 0x829D) exif.FNumber = getValue(entry, type, count, valueOffset);
    if (tag === 0x8827) exif.ISO = valueOffset;
    if (tag === 0xA434) exif.LensModel = getValue(entry, type, count, valueOffset);
  }

  return exif;
}

  /* ---------------------------------------
   キャプション生成
--------------------------------------- */
function buildCaption(exif, freeText) {
  const model = exif.Model || "Unknown Camera";
  const lens = exif.LensModel || "";
  const dt = exif.DateTimeOriginal || "--/--/-- --:--";

  let ss = "?";
  if (exif.ExposureTime) {
    if (exif.ExposureTime >= 1) ss = exif.ExposureTime.toFixed(1) + "s";
    else ss = "1/" + Math.round(1 / exif.ExposureTime) + "s";
  }

  const f = exif.FNumber ? "F/" + exif.FNumber.toFixed(1) : "F/?";
  const iso = exif.ISO ? "ISO" + exif.ISO : "ISO?";

  const line1 = `${model}　LENS：${lens}`;
  const line2 = `${dt}　　SS：${ss}　${f}　${iso}`;

  return { line1, line2, freeText };
}

  /* ---------------------------------------
   完成画像の生成（白余白 + キャプション）
--------------------------------------- */
async function renderFinalImage() {
  if (!img) return null;

  const fontSize = currentFontSize;
  const margin = currentMarginRatio * img.width;
  const extraBottom = currentExtraBottom;

  const caption = buildCaption(currentExif, currentFreeText);

  // キャンバスサイズ（写真 + 余白）
  const finalCanvas = document.createElement("canvas");
  const fctx = finalCanvas.getContext("2d");

  finalCanvas.width = img.width + margin * 2;
  finalCanvas.height = img.height + margin + extraBottom;

  // 背景（白）
  fctx.fillStyle = "#fff";
  fctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

  // 写真
  fctx.drawImage(img, margin, margin);

  // キャプション描画
  fctx.textAlign = "center";
  fctx.fillStyle = currentFontColor;
  fctx.font = `700 ${fontSize}px "${currentFontFamily}"`;

  const centerX = finalCanvas.width / 2;
  let y = img.height + margin + 40;

  // 自由キャプション
  if (caption.freeText.trim() !== "") {
    const lines = caption.freeText.split(/\r?\n/);
    fctx.font = `${currentFreeItalic ? "italic " : ""}${currentFreeWeight} ${fontSize}px "${currentFontFamily}"`;

    for (const line of lines) {
      fctx.fillText(line, centerX, y);
      y += fontSize * currentLineGap;
    }
    y += currentCaptionGap;
  }

  // line1
  fctx.font = `700 ${fontSize}px "${currentFontFamily}"`;
  fctx.fillText(caption.line1, centerX, y);
  y += fontSize * currentLineGap;

  // line2
  fctx.font = `400 ${fontSize}px "${currentFontFamily}"`;
  fctx.fillText(caption.line2, centerX, y);

  return finalCanvas;
}

  /* ---------------------------------------
   設定値（state）
--------------------------------------- */
let currentFontFamily = "Zen Antique";
let currentFontSize = 48;
let currentFontColor = "#333333";

let currentMarginRatio = 0.03;
let currentExtraBottom = 300;

let currentOffsetY = 0;
let currentLineGap = 1.4;
let currentCaptionGap = 40;

let currentFreeText = "";
let currentFreeItalic = false;
let currentFreeWeight = 400;

let currentExif = {};

  /* ---------------------------------------
   写真選択
--------------------------------------- */
document.getElementById("selectPhotoBtn").onclick = () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/jpeg,image/png";
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    currentExif = await readExif(file);
    loadImageToCanvas(file);
  };
  input.click();
};

/* ---------------------------------------
   パネル開閉
--------------------------------------- */
const toolbarItems = document.querySelectorAll(".toolbar-item");
const panel = document.getElementById("panel");
const panelTitle = document.getElementById("panelTitle");
const panelContent = document.getElementById("panelContent");

toolbarItems.forEach(item => {
  item.addEventListener("click", () => {
    toolbarItems.forEach(i => i.classList.remove("active"));
    item.classList.add("active");

    const type = item.dataset.panel;
    openPanel(type);
  });
});

function openPanel(type) {
  panel.classList.add("open");

  if (type === "font") showFontPanel();
  if (type === "size") showSizePanel();
  if (type === "pos") showPosPanel();
  if (type === "margin") showMarginPanel();
  if (type === "color") showColorPanel();
  if (type === "text") showTextPanel();
}

/* 外側タップで閉じる */
document.body.addEventListener("click", (e) => {
  if (!panel.contains(e.target) && !e.target.classList.contains("toolbar-item")) {
    panel.classList.remove("open");
    toolbarItems.forEach(i => i.classList.remove("active"));
  }
});

function showFontPanel() {
  panelTitle.textContent = "フォント";
  panelContent.innerHTML = `
    <select id="fontSelect" style="width:100%; padding:8px; font-size:16px;">
      <option value="Zen Antique">Zen Antique</option>
      <option value="Noto Sans JP">Noto Sans JP</option>
      <option value="Noto Serif JP">Noto Serif JP</option>
      <option value="Shippori Mincho">Shippori Mincho</option>
      <option value="Yuji Syuku">Yuji Syuku</option>
    </select>
  `;

  const sel = document.getElementById("fontSelect");
  sel.value = currentFontFamily;
  sel.onchange = () => {
    currentFontFamily = sel.value;
    draw();
  };
}

  function showSizePanel() {
  panelTitle.textContent = "フォントサイズ";
  panelContent.innerHTML = `
    <input id="sizeSlider" type="range" min="10" max="200" value="${currentFontSize}" style="width:100%;">
    <div style="text-align:center; margin-top:8px;">${currentFontSize}px</div>
  `;

  const slider = document.getElementById("sizeSlider");
  const label = panelContent.querySelector("div");

  slider.oninput = () => {
    currentFontSize = Number(slider.value);
    label.textContent = `${currentFontSize}px`;
    draw();
  };
}
function showPosPanel() {
  panelTitle.textContent = "キャプション位置";
  panelContent.innerHTML = `
    <input id="posSlider" type="range" min="-300" max="300" value="${currentOffsetY}" style="width:100%;">
    <div style="text-align:center; margin-top:8px;">${currentOffsetY}px</div>
  `;

  const slider = document.getElementById("posSlider");
  const label = panelContent.querySelector("div");

  slider.oninput = () => {
    currentOffsetY = Number(slider.value);
    label.textContent = `${currentOffsetY}px`;
    draw();
  };
}
  function showMarginPanel() {
  panelTitle.textContent = "余白設定";
  panelContent.innerHTML = `
    上左右余白（比率）
    <input id="marginSlider" type="range" min="0" max="0.20" step="0.01" value="${currentMarginRatio}" style="width:100%;">
    <div style="text-align:center; margin-top:8px;">${currentMarginRatio}</div>

    下余白（px）
    <input id="bottomSlider" type="range" min="0" max="2000" step="10" value="${currentExtraBottom}" style="width:100%;">
    <div style="text-align:center; margin-top:8px;">${currentExtraBottom}px</div>
  `;

  const marginSlider = document.getElementById("marginSlider");
  const marginLabel = panelContent.querySelectorAll("div")[0];

  const bottomSlider = document.getElementById("bottomSlider");
  const bottomLabel = panelContent.querySelectorAll("div")[1];

  marginSlider.oninput = () => {
    currentMarginRatio = Number(marginSlider.value);
    marginLabel.textContent = currentMarginRatio;
    draw();
  };

  bottomSlider.oninput = () => {
    currentExtraBottom = Number(bottomSlider.value);
    bottomLabel.textContent = `${currentExtraBottom}px`;
    draw();
  };
}
  function showColorPanel() {
  panelTitle.textContent = "文字色";
  panelContent.innerHTML = `
    <input id="colorPicker" type="color" value="${currentFontColor}" style="width:100%; height:50px;">
  `;

  const picker = document.getElementById("colorPicker");
  picker.oninput = () => {
    currentFontColor = picker.value;
    draw();
  };
}
function showTextPanel() {
  panelTitle.textContent = "自由キャプション";
  panelContent.innerHTML = `
    <textarea id="freeText" rows="4" style="width:100%; font-size:16px;">${currentFreeText}</textarea>
  `;

  const ta = document.getElementById("freeText");
  ta.oninput = () => {
    currentFreeText = ta.value;
    draw();
  };
}
  /* ---------------------------------------
   書き出し
--------------------------------------- */
document.getElementById("exportBtn").onclick = async () => {
  const finalCanvas = await renderFinalImage();
  if (!finalCanvas) return;

  finalCanvas.toBlob((blob) => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "captioned.jpg";
    a.click();
  }, "image/jpeg", 0.95);
};
</script>

</body>
</html>

